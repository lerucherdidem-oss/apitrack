<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Fiche Terrain â€” ApiTrack</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--honey:#F5A623;--amber:#E08A00;--green:#3DAA6C;--red:#E05A3A;--bg:#FFFBF3;--card:#FFFFFF;--border:#EAE6DC;--text:#2D2A22;--text2:#6B6558;--text3:#A09A8C;--honey-light:#FFF8EA;--honey-mid:#FDECC8}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:40px}
.header{background:linear-gradient(135deg,#2D2A22,#3D3A30);padding:16px 20px 14px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100;box-shadow:0 2px 12px rgba(0,0,0,.2)}
.header-logo{font-size:28px}.header-title{font-size:18px;font-weight:900;color:var(--honey)}.header-sub{font-size:11px;color:#A09A8C;font-weight:600}
.ruche-banner{background:linear-gradient(135deg,var(--honey),var(--amber));padding:20px;color:white;position:relative;overflow:hidden}
.ruche-banner::before{content:'beehive';position:absolute;right:20px;top:50%;transform:translateY(-50%);font-size:64px;opacity:.12}
.ruche-num-badge{display:inline-block;background:rgba(255,255,255,.25);border-radius:20px;padding:3px 12px;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.ruche-nom{font-size:28px;font-weight:900;margin-bottom:4px}.ruche-meta{font-size:13px;opacity:.85;font-weight:600}
.card{margin:14px;background:var(--card);border-radius:16px;border:2px solid var(--border);overflow:hidden}
.card-title{padding:12px 16px;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:var(--amber);background:var(--honey-light);border-bottom:1px solid var(--honey-mid);display:flex;align-items:center;gap:6px}
.card-body{padding:16px;display:flex;flex-direction:column;gap:14px}
.field-label{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:6px;display:block}
.field-input{width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:10px;font-family:'Nunito',sans-serif;font-size:15px;background:var(--bg);color:var(--text);outline:none;transition:border-color .2s;-webkit-appearance:none}
.field-input:focus{border-color:var(--honey)}
select.field-input{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23A09A8C' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px}
.reine-toggle{display:flex;gap:10px}
.reine-btn{flex:1;padding:14px;border-radius:12px;border:2px solid var(--border);background:var(--bg);font-family:'Nunito',sans-serif;font-size:14px;font-weight:800;cursor:pointer;text-align:center;transition:all .15s}
.reine-btn.active-oui{background:#E8F7EF;border-color:var(--green);color:var(--green)}
.reine-btn.active-non{background:#FDF0ED;border-color:var(--red);color:var(--red)}
.counter-row{display:flex;align-items:center;border:1.5px solid var(--border);border-radius:10px;overflow:hidden}
.counter-btn{width:52px;height:52px;background:var(--bg);border:none;font-size:24px;font-weight:700;cursor:pointer;color:var(--text2);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.counter-btn:active{background:var(--honey-mid)}.counter-val{flex:1;text-align:center;font-size:22px;font-weight:900;color:var(--text);background:white}
.score-display{background:var(--honey-light);border:1.5px solid var(--honey-mid);border-radius:12px;padding:14px 16px;display:flex;align-items:center;gap:14px}
.score-circle{width:60px;height:60px;border-radius:50%;background:var(--honey);color:white;font-size:17px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .3s}
.photo-preview{width:100%;height:220px;object-fit:cover;display:block}
.photo-placeholder{height:160px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:var(--text3);cursor:pointer;background:var(--bg)}
.photo-btn-row{display:flex;gap:10px;padding:12px}
.photo-btn{flex:1;padding:10px;border-radius:10px;border:1.5px solid var(--border);background:var(--bg);font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;color:var(--text);cursor:pointer;text-align:center}
.photo-btn.primary{background:var(--honey);border-color:var(--honey);color:white}
.save-btn{margin:14px;width:calc(100% - 28px);padding:18px;background:linear-gradient(135deg,var(--honey),var(--amber));color:white;border:none;border-radius:16px;font-family:'Nunito',sans-serif;font-size:17px;font-weight:900;cursor:pointer;box-shadow:0 4px 20px rgba(245,166,35,.4);display:block}
.save-btn:disabled{opacity:.6}
.conn-card{margin:14px;background:var(--card);border-radius:16px;border:2px solid var(--honey-mid);padding:14px}
.conn-row{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:700;color:var(--text2)}
.dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}.dot.green{background:var(--green)}.dot.red{background:var(--red)}.dot.orange{background:var(--honey)}
.offline-badge{display:none;background:#FFF3E0;border:1.5px solid #FFB74D;border-radius:10px;padding:10px 14px;font-size:12px;font-weight:700;color:#E65100;margin:0 14px 14px;text-align:center}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:12px;font-size:14px;font-weight:800;color:white;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,.2);white-space:nowrap;max-width:90vw;text-align:center}
.toast.success{background:var(--green)}.toast.error{background:var(--red)}
.pending-section{margin:14px;background:var(--card);border-radius:16px;border:2px dashed var(--honey-mid);overflow:hidden;display:none}
.pending-item{padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px}
.sync-btn{width:100%;padding:13px;background:var(--green);color:white;border:none;font-family:'Nunito',sans-serif;font-size:14px;font-weight:800;cursor:pointer}
</style>
</head>
<body>
<div class="header">
  <div class="header-logo">ğŸ</div>
  <div><div class="header-title">Fiche Terrain</div><div class="header-sub">Le Rucher d'Idem</div></div>
</div>
<div class="ruche-banner">
  <div class="ruche-num-badge">Ruche <span id="t-num">â€”</span></div>
  <div class="ruche-nom" id="t-nom">Chargement...</div>
  <div class="ruche-meta" id="t-meta">â€”</div>
</div>
<div class="conn-card">
  <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:var(--amber);margin-bottom:10px">ğŸ”— Synchronisation</div>
  <div class="conn-row"><div class="dot orange" id="dot"></div><span id="conn-status">Connexion...</span></div>
  <div id="conn-detail" style="font-size:11px;color:var(--text3);font-weight:600;margin-top:4px"></div>
</div>
<div class="offline-badge" id="offline-badge">ğŸ“µ Hors ligne â€” visite sauvegardÃ©e localement.</div>
<div class="card">
  <div class="card-title">ğŸ“· Photo de la ruche</div>
  <div id="photo-container">
    <div class="photo-placeholder" onclick="document.getElementById('photo-cam').click()">
      <div style="font-size:40px">ğŸ“¸</div>
      <div style="font-size:13px;font-weight:700">Appuyer pour photographier</div>
    </div>
  </div>
  <div class="photo-btn-row">
    <button class="photo-btn primary" onclick="document.getElementById('photo-cam').click()">ğŸ“· Appareil photo</button>
    <button class="photo-btn" onclick="document.getElementById('photo-gal').click()">ğŸ–¼ï¸ Galerie</button>
    <button class="photo-btn" id="photo-clear-btn" onclick="clearPhoto()" style="display:none;color:var(--red)">ğŸ—‘ï¸</button>
  </div>
  <input type="file" id="photo-cam" accept="image/*" capture="environment" style="display:none" onchange="handlePhoto(this)">
  <input type="file" id="photo-gal" accept="image/*" style="display:none" onchange="handlePhoto(this)">
</div>
<div class="card">
  <div class="card-title">ğŸ” Inspection</div>
  <div class="card-body">
    <div><label class="field-label">ğŸ“… Date et Heure</label><input type="datetime-local" id="t-date" class="field-input"></div>
    <div><label class="field-label">ğŸ‘‘ Reine vue ?</label>
      <div class="reine-toggle">
        <button class="reine-btn" id="btn-oui" onclick="setReine(true)">âœ… Oui</button>
        <button class="reine-btn" id="btn-non" onclick="setReine(false)">âŒ Non</button>
        <button class="reine-btn" id="btn-nd" onclick="setReine(null)" style="flex:.5;font-size:12px">â€”</button>
      </div>
    </div>
    <div><label class="field-label">ğŸ Population</label>
      <select id="t-pop" class="field-input" onchange="calcScore()">
        <option value="">â€” Non Ã©valuÃ© â€”</option><option value="faible">Faible</option>
        <option value="moyenne">Moyenne</option><option value="forte">Forte</option><option value="trÃ¨s forte">TrÃ¨s forte</option>
      </select>
    </div>
    <div><label class="field-label">ğŸ§± Cadres de couvain</label>
      <div class="counter-row"><button class="counter-btn" onclick="counter('t-couvain',-1)">âˆ’</button><div class="counter-val" id="t-couvain">0</div><button class="counter-btn" onclick="counter('t-couvain',1)">+</button></div>
    </div>
    <div><label class="field-label">ğŸ“¦ Hausses</label>
      <div class="counter-row"><button class="counter-btn" onclick="counter('t-hausses',-1)">âˆ’</button><div class="counter-val" id="t-hausses">0</div><button class="counter-btn" onclick="counter('t-hausses',1)">+</button></div>
    </div>
    <div><label class="field-label">ğŸ¯ RÃ©serves</label>
      <select id="t-reserves" class="field-input" onchange="calcScore()">
        <option value="">â€” Non Ã©valuÃ© â€”</option><option value="insuffisantes">Insuffisantes âš ï¸</option>
        <option value="correctes">Correctes</option><option value="abondantes">Abondantes</option>
      </select>
    </div>
    <div><label class="field-label">ğŸŒ¤ï¸ MÃ©tÃ©o</label>
      <select id="t-meteo" class="field-input">
        <option value="">â€”</option><option value="ensoleillÃ©">â˜€ï¸ EnsoleillÃ©</option>
        <option value="nuageux">â›… Nuageux</option><option value="couvert">â˜ï¸ Couvert</option>
        <option value="pluie">ğŸŒ§ï¸ Pluie</option><option value="vent">ğŸ’¨ Vent</option>
      </select>
    </div>
    <div><label class="field-label">ğŸ˜¤ TempÃ©rament</label>
      <select id="t-temperament" class="field-input">
        <option value="">â€”</option><option value="calme">ğŸ˜Š Calme</option>
        <option value="normal">ğŸ˜ Normal</option><option value="nerveux">ğŸ˜  Nerveux</option><option value="agressif">ğŸš¨ Agressif</option>
      </select>
    </div>
    <div><label class="field-label">ğŸ“ Observations</label>
      <textarea id="t-obs" class="field-input" rows="4" placeholder="Cellules royales, comportement, travaux effectuÃ©s..."></textarea>
    </div>
    <div class="score-display">
      <div class="score-circle" id="t-score">â€”</div>
      <div><div style="font-size:13px;font-weight:700;color:var(--text2)">Score de santÃ© estimÃ©</div>
      <div id="t-score-detail" style="font-size:11px;color:var(--text3);margin-top:2px">Remplissez pour calculer</div></div>
    </div>
  </div>
</div>
<button class="save-btn" id="save-btn" onclick="saveVisite()">ğŸ’¾ Enregistrer la visite</button>
<div class="pending-section" id="pending-section">
  <div class="card-title">â³ En attente de synchronisation</div>
  <div id="pending-list"></div>
  <button class="sync-btn" onclick="syncPending()">ğŸ”„ Synchroniser maintenant</button>
</div>
<script>
const SUPABASE_URL = "https://usuzzqsrddpqjlrhpsqt.supabase.co";
const SUPABASE_ANON_KEY = "TON_ANON_KEY_eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzdXp6cXNyZGRwcWpscmhwc3F0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1OTIwNjAsImV4cCI6MjA4NzE2ODA2MH0.yNIXTh2s-D1iirIULe54iB1zevNWD-kqdktwPxlksSc";
let sb=null,currentUser=null,reineVue=null,photoDataUrl=null;
const params=new URLSearchParams(window.location.search);
const RUCHE_ID=params.get('visite')||params.get('id')||'';
const RUCHE_NUM=params.get('n')||'?';
const RUCHE_NOM=decodeURIComponent(params.get('nom')||('Ruche #'+RUCHE_NUM));
const RUCHE_RUCHER=decodeURIComponent(params.get('rucher')||'');
const RUCHE_TYPE=decodeURIComponent(params.get('type')||'Dadant');
document.getElementById('t-num').textContent=RUCHE_NUM;
document.getElementById('t-nom').textContent=RUCHE_NOM;
document.getElementById('t-meta').textContent=[RUCHE_RUCHER,RUCHE_TYPE].filter(Boolean).join(' Â· ');
document.title='Ruche '+RUCHE_NUM+' â€” '+RUCHE_NOM;
(function(){const now=new Date(),pad=n=>String(n).padStart(2,'0');
document.getElementById('t-date').value=now.getFullYear()+'-'+pad(now.getMonth()+1)+'-'+pad(now.getDate())+'T'+pad(now.getHours())+':'+pad(now.getMinutes());})();
async function initSupabase(){
  if(!SB_URL||!SB_KEY){setConn('red','Non configurÃ©','Ouvrez l\'appli principale');return;}
  try{sb=window.supabase.createClient(SB_URL,SB_KEY);
    const{data}=await sb.auth.getSession();
    if(data?.session?.user){currentUser=data.session.user;setConn('green','ConnectÃ© â€” synchro active',currentUser.email);syncPending();}
    else setConn('orange','Non connectÃ©','Sauvegarde locale uniquement');
  }catch(e){setConn('red','Erreur',e.message);}
  renderPending();
}
function setConn(color,msg,detail){
  document.getElementById('dot').className='dot '+color;
  document.getElementById('conn-status').textContent=msg;
  document.getElementById('conn-detail').textContent=detail||'';
}
window.addEventListener('online',()=>{document.getElementById('offline-badge').style.display='none';syncPending();});
window.addEventListener('offline',()=>{document.getElementById('offline-badge').style.display='block';});
if(!navigator.onLine)document.getElementById('offline-badge').style.display='block';
function handlePhoto(input){const file=input.files[0];if(!file)return;const reader=new FileReader();
  reader.onload=e=>{photoDataUrl=e.target.result;
    document.getElementById('photo-container').innerHTML='<img src="'+photoDataUrl+'" class="photo-preview" alt="Photo">';
    document.getElementById('photo-clear-btn').style.display='block';};
  reader.readAsDataURL(file);}
function clearPhoto(){photoDataUrl=null;
  document.getElementById('photo-container').innerHTML='<div class="photo-placeholder" onclick="document.getElementById(\'photo-cam\').click()"><div style="font-size:40px">ğŸ“¸</div><div style="font-size:13px;font-weight:700">Appuyer pour photographier</div></div>';
  document.getElementById('photo-clear-btn').style.display='none';}
function setReine(val){reineVue=val;
  document.getElementById('btn-oui').className='reine-btn'+(val===true?' active-oui':'');
  document.getElementById('btn-non').className='reine-btn'+(val===false?' active-non':'');
  document.getElementById('btn-nd').className='reine-btn';calcScore();}
function counter(id,delta){const el=document.getElementById(id);el.textContent=Math.max(0,parseInt(el.textContent||'0')+delta);calcScore();}
function calcScore(){let score=100;const d=[];
  if(reineVue===false){score-=25;d.push('Reine non vue âˆ’25');}else if(reineVue===true)d.push('Reine vue âœ“');
  if(document.getElementById('t-pop').value==='faible'){score-=20;d.push('Population faible âˆ’20');}
  if(document.getElementById('t-reserves').value==='insuffisantes'){score-=15;d.push('RÃ©serves insuffisantes âˆ’15');}
  score=Math.max(0,Math.min(100,score));
  const el=document.getElementById('t-score');el.textContent=score+'%';
  el.style.background=score>=70?'var(--green)':score>=40?'var(--honey)':'var(--red)';
  document.getElementById('t-score-detail').textContent=d.join(' Â· ')||'DonnÃ©es insuffisantes';}
async function saveVisite(){
  const btn=document.getElementById('save-btn');btn.disabled=true;btn.textContent='â³ Enregistrement...';
  const data={ruche_id:RUCHE_ID,date_visite:document.getElementById('t-date').value||new Date().toISOString().slice(0,16),
    reine_vue:reineVue,population:document.getElementById('t-pop').value||null,
    nb_cadres_couvain:parseInt(document.getElementById('t-couvain').textContent)||null,
    nb_hausses:parseInt(document.getElementById('t-hausses').textContent)||0,
    meteo:document.getElementById('t-meteo').value||null,observations:document.getElementById('t-obs').value||null,
    agressivite:({'calme':0,'normal':1,'nerveux':3,'agressif':5})[document.getElementById('t-temperament').value]||0,
    essaimage_signes:false,source:'terrain',_nom:RUCHE_NOM,_num:RUCHE_NUM,_at:new Date().toISOString()};
  if(sb&&currentUser&&navigator.onLine){
    try{const payload={ruche_id:data.ruche_id,date_visite:data.date_visite,reine_vue:data.reine_vue,
        population:data.population,nb_cadres_couvain:data.nb_cadres_couvain,nb_hausses:data.nb_hausses,
        meteo:data.meteo,observations:data.observations,agressivite:data.agressivite,
        essaimage_signes:false,inspecteur_id:currentUser.id};
      const{error}=await sb.from('visites').insert(payload);
      if(error)throw error;showToast('âœ… Visite enregistrÃ©e !','success');resetForm();
    }catch(e){saveLocal(data);showToast('âš ï¸ SauvegardÃ© localement','error');}
  }else{saveLocal(data);showToast('ğŸ“µ SauvegardÃ© localement','success');}
  btn.disabled=false;btn.textContent='ğŸ’¾ Enregistrer la visite';}
function saveLocal(data){const p=JSON.parse(localStorage.getItem('terrain_pending')||'[]');p.push(data);localStorage.setItem('terrain_pending',JSON.stringify(p));renderPending();}
async function syncPending(){if(!sb||!currentUser||!navigator.onLine)return;
  const pending=JSON.parse(localStorage.getItem('terrain_pending')||'[]');if(!pending.length)return;
  let synced=0;const remaining=[];
  for(const v of pending){try{
    const payload={ruche_id:v.ruche_id,date_visite:v.date_visite,reine_vue:v.reine_vue,
      population:v.population,nb_cadres_couvain:v.nb_cadres_couvain,nb_hausses:v.nb_hausses,
      meteo:v.meteo,observations:v.observations,agressivite:v.agressivite,essaimage_signes:false,inspecteur_id:currentUser.id};
    const{error}=await sb.from('visites').insert(payload);if(error)throw error;synced++;
  }catch(e){remaining.push(v);}}
  localStorage.setItem('terrain_pending',JSON.stringify(remaining));
  if(synced)showToast('âœ… '+synced+' visite(s) synchronisÃ©e(s) !','success');renderPending();}
function renderPending(){const pending=JSON.parse(localStorage.getItem('terrain_pending')||'[]');
  const section=document.getElementById('pending-section');
  if(!pending.length){section.style.display='none';return;}
  section.style.display='block';
  document.getElementById('pending-list').innerHTML=pending.map(v=>
    '<div class="pending-item"><strong>'+(v._nom||'Ruche #'+v._num)+'</strong> â€” '+new Date(v.date_visite).toLocaleDateString('fr-FR')+
    '<span style="color:var(--text3);font-size:11px"> Â· '+(v.observations?v.observations.substring(0,30)+'â€¦':'â€”')+'</span></div>').join('');}
function resetForm(){setReine(null);
  ['t-obs','t-pop','t-reserves','t-meteo','t-temperament'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('t-couvain').textContent='0';document.getElementById('t-hausses').textContent='0';
  clearPhoto();calcScore();}
function showToast(msg,type){const t=document.createElement('div');t.className='toast '+type;t.textContent=msg;
  document.body.appendChild(t);setTimeout(()=>t.remove(),3500);}
initSupabase();calcScore();
</script>
</body>
</html>
